// packages/database/prisma/schema.prisma

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

// Representa a un Owner de tienda (vinculado a Supabase Auth)
model User {
    id        String   @id @default(uuid())
    email     String   @unique
    username  String?  @unique
    name      String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    stores Store[]
}

model Store {
    id                    String   @id @default(uuid())
    name                  String
    slug                  String   @unique
    autoGenerateSlug      Boolean  @default(true)
    description           String?
    logoUrl               String?
    whatsappNumber        String?
    instagramUrl          String?
    facebookUrl           String?
    tiktokUrl             String?
    twitterUrl            String?
    pinterestUrl          String?
    youtubeUrl            String?
    theme                 String?  @default("classic")
    mode                  String?  @default("light")
    applyThemeToDashboard Boolean? @default(false)
    deliveryEnabled       Boolean  @default(true)
    deliveryPrice         String?  @default("Gratis")
    createdAt             DateTime @default(now())
    updatedAt             DateTime @updatedAt

    userId String
    user   User   @relation(fields: [userId], references: [id])

    categories Category[]
    products   Product[]
    orders     Order[]
}

model Category {
    id       String    @id @default(uuid())
    name     String
    slug     String
    storeId  String
    store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
    products Product[]

    @@unique([storeId, slug])
}

model Product {
    id             String   @id @default(uuid())
    name           String
    sku            String?
    description    String?
    price          Decimal? @db.Decimal(10, 2)
    discountPrice  Decimal? @db.Decimal(10, 2)
    images         String[]
    isActive       Boolean  @default(true)
    trackInventory Boolean  @default(true)

    storeId String
    store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

    categoryId String?
    category   Category? @relation(fields: [categoryId], references: [id])

    inventory  Inventory?
    orderItems OrderItem[]

    variants ProductVariant[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model ProductVariant {
    id   String @id @default(uuid())
    name String

    // Precio y stock opcionales
    price Decimal? @db.Decimal(10, 2)
    stock Int      @default(0)

    // Flags para heredar del producto padre
    useParentPrice Boolean @default(false)
    useParentStock Boolean @default(false)

    sku String?

    // DEPRECATED: se reemplaza por images[]
    image String?

    // Imágenes específicas de la variante (máximo 2)
    images String[] @default([])

    productId String
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    orderItems OrderItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Inventory {
    id        String  @id @default(uuid())
    stock     Int     @default(0)
    productId String  @unique
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

enum OrderStatus {
    PENDING
    CONFIRMED
    CANCELLED
    COMPLETED
}

model Order {
    id              String      @id @default(uuid())
    total           Decimal     @db.Decimal(10, 2)
    status          OrderStatus @default(PENDING)
    customerName    String
    customerPhone   String?
    customerAddress String?

    storeId String
    store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

    items OrderItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model OrderItem {
    id          String  @id @default(uuid())
    quantity    Int
    price       Decimal @db.Decimal(10, 2)
    productName String
    sku         String?

    orderId String
    order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

    productId String?
    product   Product? @relation(fields: [productId], references: [id])

    variantId   String?
    variant     ProductVariant? @relation(fields: [variantId], references: [id])
    variantName String?
}
